<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Video Downloader</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --bg: #0f172a;
            --bg-card: #1e293b;
            --bg-input: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
            --radius: 12px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        .logo-icon {
            font-size: 2.5rem;
        }

        h1 {
            font-size: 1.75rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .status-badges {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge.loading {
            background: var(--bg-input);
            color: var(--text-muted);
        }

        .badge.success {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Input Section */
        .input-section {
            margin-bottom: 2rem;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }

        input[type="text"] {
            flex: 1;
            padding: 1rem 1.25rem;
            background: var(--bg-input);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            color: var(--text);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        input[type="text"]::placeholder {
            color: var(--text-muted);
        }

        .hint {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Buttons */
        .btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: var(--success);
            color: white;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-success:hover {
            filter: brightness(1.1);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Error Message */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Video Info Card */
        .video-info {
            margin-bottom: 2rem;
        }

        .video-card {
            background: var(--bg-card);
            border-radius: var(--radius);
            overflow: hidden;
            display: flex;
            gap: 1.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .thumbnail-container {
            flex-shrink: 0;
            width: 200px;
            aspect-ratio: 16/9;
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-input);
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-details {
            flex: 1;
            min-width: 0;
        }

        .video-details h2 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .uploader {
            color: var(--text-muted);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .meta-info {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .platform, .duration {
            background: var(--bg-input);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Format Selection */
        .format-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-input);
            border: 2px solid transparent;
            border-radius: var(--radius);
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: var(--bg-card);
        }

        .tab-btn.active {
            background: var(--bg-card);
            border-color: var(--primary);
            color: var(--text);
        }

        .format-list {
            display: none;
        }

        .format-list.active {
            display: block;
        }

        .format-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 0.75rem;
        }

        .format-option {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .format-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .format-option.selected {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .format-option .quality {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .format-option .size {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Download Section */
        .download-section {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem;
        }

        .progress-container {
            margin-bottom: 0.5rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        #download-status {
            color: var(--text-muted);
        }

        #download-percent {
            font-weight: 600;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-input);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #a855f7);
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 3rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border);
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .input-group {
                flex-direction: column;
            }
            
            .video-card {
                flex-direction: column;
            }
            
            .thumbnail-container {
                width: 100%;
            }
            
            .options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="logo-icon">ðŸŽ¬</span>
                <h1>Universal Video Downloader</h1>
            </div>
            <p class="subtitle">Download video & audio dari berbagai platform</p>
            <div id="status-badges" class="status-badges">
                <span class="badge loading" id="ytdlp-badge">yt-dlp: checking...</span>
                <span class="badge loading" id="ffmpeg-badge">ffmpeg: checking...</span>
            </div>
        </header>

        <main>
            <!-- URL Input Section -->
            <section class="input-section">
                <div class="input-group">
                    <input 
                        type="text" 
                        id="url-input" 
                        placeholder="Paste URL video di sini (YouTube, TikTok, Instagram, dll)"
                        autocomplete="off"
                    >
                    <button id="fetch-btn" class="btn btn-primary">
                        <span class="btn-text">Ambil Info</span>
                        <span class="btn-loading" style="display: none;">
                            <div class="spinner"></div>
                        </span>
                    </button>
                </div>
                <p class="hint">Mendukung: YouTube, TikTok, Instagram, Twitter/X, Facebook, dan 1000+ situs lainnya</p>
            </section>

            <!-- Error Message -->
            <div id="error-message" class="error-message" style="display: none;"></div>

            <!-- Video Info Section -->
            <section id="video-info" class="video-info" style="display: none;">
                <div class="video-card">
                    <div class="thumbnail-container">
                        <img id="video-thumbnail" src="" alt="Thumbnail">
                    </div>
                    <div class="video-details">
                        <h2 id="video-title"></h2>
                        <p class="uploader">
                            <span class="icon">ðŸ‘¤</span>
                            <span id="video-uploader"></span>
                        </p>
                        <div class="meta-info">
                            <span class="platform" id="video-platform"></span>
                            <span class="duration" id="video-duration"></span>
                        </div>
                    </div>
                </div>

                <!-- Format Selection -->
                <div class="format-selection">
                    <div class="format-tabs">
                        <button class="tab-btn active" data-tab="audio">
                            <span class="icon">ðŸŽµ</span> Audio (MP3)
                        </button>
                        <button class="tab-btn" data-tab="video">
                            <span class="icon">ðŸŽ¬</span> Video (MP4)
                        </button>
                    </div>

                    <!-- Audio Formats -->
                    <div id="audio-formats" class="format-list active">
                        <p class="format-hint">Pilih kualitas audio:</p>
                        <div id="audio-options" class="options-grid"></div>
                    </div>

                    <!-- Video Formats -->
                    <div id="video-formats" class="format-list">
                        <p class="format-hint">Pilih kualitas video:</p>
                        <div id="video-options" class="options-grid"></div>
                    </div>
                </div>
            </section>

            <!-- Download Progress Section -->
            <section id="download-section" class="download-section" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <span id="download-status">Memulai download...</span>
                        <span id="download-percent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
                <button id="download-file-btn" class="btn btn-success" style="display: none;">
                    <span class="icon">ðŸ“¥</span> Download File
                </button>
            </section>
        </main>

        <footer>
            <p>Powered by <a href="https://github.com/yt-dlp/yt-dlp" target="_blank">yt-dlp</a> & Flask</p>
        </footer>
    </div>

    <script>
        // Check dependencies on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded, initializing app...');
            checkDependencies();
            setupEventListeners();
        });

        async function checkDependencies() {
            try {
                console.log('Checking dependencies...');
                const response = await fetch('/check-dependencies');
                const data = await response.json();
                
                console.log('Dependencies:', data);
                
                const ytdlpBadge = document.getElementById('ytdlp-badge');
                const ffmpegBadge = document.getElementById('ffmpeg-badge');
                
                ytdlpBadge.textContent = `yt-dlp: ${data.ytdlp ? 'âœ“' : 'âœ—'}`;
                ytdlpBadge.className = `badge ${data.ytdlp ? 'success' : 'error'}`;
                
                ffmpegBadge.textContent = `ffmpeg: ${data.ffmpeg ? 'âœ“' : 'âœ—'}`;
                ffmpegBadge.className = `badge ${data.ffmpeg ? 'success' : 'error'}`;
            } catch (error) {
                console.error('Failed to check dependencies:', error);
            }
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            const fetchBtn = document.getElementById('fetch-btn');
            const urlInput = document.getElementById('url-input');
            
            fetchBtn.addEventListener('click', () => {
                console.log('Fetch button clicked');
                fetchVideoInfo();
            });
            
            urlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    console.log('Enter key pressed');
                    fetchVideoInfo();
                }
            });
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.format-list').forEach(l => l.classList.remove('active'));
                    
                    btn.classList.add('active');
                    const tabId = btn.dataset.tab + '-formats';
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            console.log('Event listeners set up successfully');
        }

        async function fetchVideoInfo() {
            console.log('fetchVideoInfo called');
            const urlInput = document.getElementById('url-input');
            const fetchBtn = document.getElementById('fetch-btn');
            const errorMessage = document.getElementById('error-message');
            const videoInfo = document.getElementById('video-info');
            
            const url = urlInput.value.trim();
            console.log('URL:', url);
            
            if (!url) {
                showError('Masukkan URL video terlebih dahulu');
                return;
            }
            
            // Show loading
            fetchBtn.disabled = true;
            fetchBtn.querySelector('.btn-text').style.display = 'none';
            fetchBtn.querySelector('.btn-loading').style.display = 'flex';
            errorMessage.style.display = 'none';
            videoInfo.style.display = 'none';
            
            try {
                console.log('Fetching video info...');
                const response = await fetch('/get-info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                
                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Response data:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Gagal mengambil informasi video');
                }
                
                displayVideoInfo(data, url);
                
            } catch (error) {
                console.error('Error:', error);
                showError(error.message);
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.querySelector('.btn-text').style.display = 'inline';
                fetchBtn.querySelector('.btn-loading').style.display = 'none';
            }
        }

        function displayVideoInfo(data, url) {
            console.log('Displaying video info:', data);
            const videoInfo = document.getElementById('video-info');
            
            document.getElementById('video-thumbnail').src = data.thumbnail || '';
            document.getElementById('video-title').textContent = data.title;
            document.getElementById('video-uploader').textContent = data.uploader;
            document.getElementById('video-platform').textContent = data.platform;
            document.getElementById('video-duration').textContent = formatDuration(data.duration);
            
            // Populate audio options
            const audioOptions = document.getElementById('audio-options');
            audioOptions.innerHTML = '';
            data.audio_formats.forEach(fmt => {
                const option = createFormatOption(fmt, 'audio', url, data.title);
                audioOptions.appendChild(option);
            });
            
            // Populate video options
            const videoOptions = document.getElementById('video-options');
            videoOptions.innerHTML = '';
            data.video_formats.forEach(fmt => {
                const option = createFormatOption(fmt, 'video', url, data.title);
                videoOptions.appendChild(option);
            });
            
            videoInfo.style.display = 'block';
        }

        function createFormatOption(fmt, type, url, title) {
            const div = document.createElement('div');
            div.className = 'format-option';
            
            const quality = type === 'audio' 
                ? `${fmt.abr || '?'}kbps`
                : `${fmt.height}p`;
            
            const size = fmt.filesize 
                ? formatFileSize(fmt.filesize)
                : 'Unknown size';
            
            div.innerHTML = `
                <div class="quality">${quality}</div>
                <div class="size">${size}</div>
            `;
            
            div.addEventListener('click', () => {
                document.querySelectorAll('.format-option').forEach(o => o.classList.remove('selected'));
                div.classList.add('selected');
                startDownload(url, type, fmt.id, title);
            });
            
            return div;
        }

        async function startDownload(url, type, formatId, title) {
            console.log('Starting download:', {url, type, formatId, title});
            const downloadSection = document.getElementById('download-section');
            const downloadStatus = document.getElementById('download-status');
            const downloadPercent = document.getElementById('download-percent');
            const progressFill = document.getElementById('progress-fill');
            const downloadFileBtn = document.getElementById('download-file-btn');
            
            downloadSection.style.display = 'block';
            downloadFileBtn.style.display = 'none';
            downloadStatus.textContent = 'Memulai download...';
            downloadPercent.textContent = '0%';
            progressFill.style.width = '0%';
            
            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, type, format_id: formatId, title })
                });
                
                const data = await response.json();
                console.log('Download started:', data);
                
                if (!response.ok) {
                    throw new Error(data.error || 'Gagal memulai download');
                }
                
                // Poll for progress
                pollProgress(data.download_id);
                
            } catch (error) {
                console.error('Download error:', error);
                downloadStatus.textContent = `Error: ${error.message}`;
                progressFill.style.background = 'var(--error)';
            }
        }

        async function pollProgress(downloadId) {
            console.log('Polling progress for:', downloadId);
            const downloadStatus = document.getElementById('download-status');
            const downloadPercent = document.getElementById('download-percent');
            const progressFill = document.getElementById('progress-fill');
            const downloadFileBtn = document.getElementById('download-file-btn');
            
            const poll = async () => {
                try {
                    const response = await fetch(`/progress/${downloadId}`);
                    const data = await response.json();
                    
                    console.log('Progress:', data);
                    
                    if (data.status === 'downloading') {
                        downloadStatus.textContent = 'Mengunduh...';
                        downloadPercent.textContent = `${Math.round(data.progress)}%`;
                        progressFill.style.width = `${data.progress}%`;
                        setTimeout(poll, 500);
                    } else if (data.status === 'completed') {
                        downloadStatus.textContent = 'Download selesai!';
                        downloadPercent.textContent = '100%';
                        progressFill.style.width = '100%';
                        downloadFileBtn.style.display = 'flex';
                        downloadFileBtn.onclick = () => {
                            window.location.href = `/download-file/${downloadId}`;
                        };
                    } else if (data.status === 'error') {
                        downloadStatus.textContent = `Error: ${data.message}`;
                        progressFill.style.background = 'var(--error)';
                    } else {
                        setTimeout(poll, 500);
                    }
                } catch (error) {
                    console.error('Poll error:', error);
                    downloadStatus.textContent = 'Error: Connection lost';
                }
            };
            
            poll();
        }

        function formatDuration(seconds) {
            if (!seconds) return '--:--';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function formatFileSize(bytes) {
            if (!bytes) return '';
            const mb = bytes / (1024 * 1024);
            if (mb < 1) {
                return `${(bytes / 1024).toFixed(1)} KB`;
            }
            return `${mb.toFixed(1)} MB`;
        }

        function showError(message) {
            console.error('Showing error:', message);
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }
    </script>
</body>
</html>
